version: '3.7'
networks:
  overlay:
    driver: overlay
    attachable: true
services:
  rabbitmq:
    image: rabbitmq:3-alpine
    networks:
    - overlay
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/passwd:/etc/passwd:ro
    - /vol/www/oregoninvasiveshotline/services/rabbitmq:/var/lib/rabbitmq
    logging:
      driver: json-file
    deploy:
      endpoint_mode: dnsrr
      replicas: 1
    hostname: rabbitmq-stage
    user: 1101:1101
  app:
    image: ghcr.io/psu-oit-arc/oregoninvasiveshotline/app-stage:1.15.11
    networks:
    - overlay
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/passwd:/etc/passwd:ro
    - /vol/store/media:/vol/store/media
    - /vol/www/oregoninvasiveshotline:/vol/www/oregoninvasiveshotline
    - ./uwsgi:/uwsgi
    - ./:/app
    environment:
    - EMCEE_CMD_ENV=stage
    - APP_SERVICE=wsgi
    logging:
      driver: json-file
    deploy:
      replicas: 1
    user: invasives:invasives
  celery:
    image: ghcr.io/psu-oit-arc/oregoninvasiveshotline/app-stage:1.15.11
    networks:
    - overlay
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/passwd:/etc/passwd:ro
    - /vol/store/media:/vol/store/media
    - /vol/www/oregoninvasiveshotline:/vol/www/oregoninvasiveshotline
    - ./:/app
    environment:
    - EMCEE_CMD_ENV=stage
    - APP_SERVICE=celery
    logging:
      driver: json-file
    deploy:
      replicas: 1
    depends_on:
    - rabbitmq
    user: invasives:invasives
  scheduler:
    image: ghcr.io/psu-oit-arc/oregoninvasiveshotline/app-stage:1.15.11
    networks:
    - overlay
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /etc/passwd:/etc/passwd:ro
    - /vol/store/media:/vol/store/media
    - /vol/www/oregoninvasiveshotline:/vol/www/oregoninvasiveshotline
    - ./:/app
    environment:
    - EMCEE_CMD_ENV=stage
    - APP_SERVICE=scheduler
    logging:
      driver: json-file
    deploy:
      replicas: 1
    depends_on:
    - rabbitmq
    user: invasives:invasives
  proxy:
    image: nginx:stable
    networks:
    - overlay
    ports:
    - target: 80
      published: 80
      protocol: tcp
      mode: host
    volumes:
    - /etc/localtime:/etc/localtime:ro
    - /vol/store/media:/media
    - /vol/www/oregoninvasiveshotline/static:/static
    - ./nginx/oregoninvasiveshotline.conf:/etc/nginx/conf.d/default.conf
    - ./nginx/host_defaults.conf:/etc/nginx/host_defaults.conf
    - ./nginx/server_defaults.conf:/etc/nginx/server_defaults.conf
    logging:
      driver: json-file
    deploy:
      mode: global
      resources:
        limits:
          memory: 128M
    depends_on:
    - app
