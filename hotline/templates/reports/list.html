{% extends "base.html" %}
{% block content %}
<form>
    <div class="row">
        <div class="col-md-4">
            {{ form.querystring|bootstrap }}
        </div>
        <div class="col-md-2">
            {{ form.claimed_by|bootstrap }}
        </div>
        <div class="col-md-2">
            {{ form.is_public|bootstrap }}
        </div>
        <div class="col-md-2">
            {{ form.is_archived|bootstrap }}
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label class="control-label">&nbsp;</label>
                <div></div>
                <input type="submit" value="Search" name="submit" />
            </div>
        </div>
    </div>
    {% if reports %}
        <div id="map-canvas" style="height:400px"></div>
        <p class="reports-table-sort">Sort By:
            {% for subwidget in form.sort_by %}
                <a href="{% add_get sort_by=subwidget.choice_value %}">{{ subwidget.choice_label }}</a>
            {% endfor %}
        </p>
        <table class="table reports-table double-zebra">
            <tbody>
                {% for report in reports %}
                    <tr>
                        <td rowspan="2" class="reports-table-img">
                            {% if report.image_url %}
                                <a href="{% url 'reports-detail' report.pk %}">
                                    <img src="{{ report.image_url }}" style="max-width:64px; max-height:64px" />
                                </a>
                            {% endif %}
                        </td>
                        <td colspan="3" class="reports-table-title"><a href="{% url 'reports-detail' report.pk %}"><small>#{{ report.pk }}:</small> {{ report.species.name|default:report.category }}</a></td>
                        <td class="text-right" style="font-size:18px">
                            {% if report.is_public %}
                                <span class="glyphicon glyphicon-eye-open" title="Public"></span>
                            {% endif %}
                            {% if report.actual_species %}
                                <span class="glyphicon glyphicon-ok" title="Confirmed"></span>
                            {% endif %}
                            {% if report.is_archived %}
                                <span class="glyphicon glyphicon-oil" title="Archived"></span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>{{ report.created_on }}</td>
                        <td><em>Region:</em> {{ report.county|default:"foo" }}</td>
                        <td><em title="Early Detection and Rapid Response">EDRR Status:</em> {{ report.get_edrr_status_display|default:"None" }}</td>
                        <td class="text-right"><em>Claimed By:</em> {% if report.claimed_by_id == user.pk %}<strong class="text-success">YOU</strong>{% else %}{{ report.claimed_by|default:"Nobody" }}{% endif %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% include '_pagination.html' with items=reports %}
    {% else %}
        <div class="alert alert-warning">No matching reports found!</div>
    {% endif %}
</form>
<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyDRamH3fauUUQow07BOuep8gojIvCiGpm4"></script>
<script>
reports = {{ reports_json|safe }}
google.maps.event.addDomListener(window, 'load', function(){;
    if(reports.length == 0){
        return;
    }
    var mapOptions = {
        center: {
            lat: 0, lng: 0
        },
        zoom: 4,
        streetViewControl: false,
    };
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    // we need to save all the "info windows" we create, so we can close them
    // all when a balloon is clicked (so only one window opens at a time)
    var windows = []
    // for each report, draw the marker on the map where the report was located
    for(var i = 0; i < reports.length; i++){
        var report = reports[i];
        var marker = new google.maps.Marker({
            position: {
                lat: report.lat,
                lng: report.lng
            },
            map: map,
            title: report.title,
            icon: generateIcon(report.icon),
        });

        var infowindow = new google.maps.InfoWindow({
            content: report.content
        });

        // we keep track of all the
        windows.push(infowindow)

        with({map: map, marker: marker, infowindow: infowindow}){
            google.maps.event.addListener(marker, 'click', function() {
                for(var i = 0; i < windows.length; i++){
                    windows[i].close()
                }
                infowindow.open(map, marker);
            });
        }
    }
})
</script>
{% endblock %}
